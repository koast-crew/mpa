<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="koast.admin.repository.UserMapper">

    <!-- 여기에 User를 ResultMap으로 만들어서 사용해야 함
    <resultMap id="UserWithGroupMap" type="user">
        <id property="userId" />
        ... 생략. pk만 id 그 외 컬럼은 result ...
        <association property="userGroup" javaType="userGroup">
            <id property="userGroupId" />
            <result property="userGroupName" />
            ... 생략 ...
        </association>
    </resultMap>
     -->

    <!-- 세션 정보 -->
    <select id="findByUserIdAndPolicy" parameterType="userLoginRequest" resultType="userSession">
        /* findByUserIdAndPolicy */
        SELECT A.*, B.user_group_name AS userGroupName,
			<![CDATA[
               CASE WHEN A.last_password_change_date < (NOW() - INTERVAL '${passwordChangeTerm} DAY') THEN true
                    ELSE false
                   END AS password_change_term_over,
			]]>
			<![CDATA[
			CASE WHEN A.last_login_date IS NULL THEN A.created_date < (NOW() - INTERVAL '${lastLoginLock} DAY')
                    ELSE A.last_login_date < (NOW() - INTERVAL '${lastLoginLock} DAY')
                   END AS last_login_lock_over
			]]>
		FROM user_info A LEFT OUTER JOIN user_group B ON A.user_group_id = B.user_group_id
        WHERE A.user_id = #{userId}
    </select>

    <!-- 사용자 로그인 정보 수정 -->
    <update id="updateLoginUser" parameterType="userSession">
        /* updateLoginUser */
        UPDATE user_info
        SET
        <if test="status != null and status != ''">
            status = #{status},
            modified_date = NOW(),
        </if>
        <if test="failLoginCount != null and failLoginCount gte 0">
            fail_login_count = #{failLoginCount},
        </if>
        last_login_date = NOW()
        WHERE user_id = #{userId}
    </update>
</mapper>